name: C CI/CD with Static Analysis and Build

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch: {}  # allow manual runs

jobs:
  build_and_analysis:
    name: Cppcheck + Build
    runs-on: windows-latest

    steps:
      # -------------------------------
      # 1. Checkout your code
      # -------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4

      # -------------------------------
      # 2. Run static analysis (Cppcheck)
      # -------------------------------
      - name: Run Cppcheck analysis
        uses: deep5050/cppcheck-action@main
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          enable: all
          std: c11
          output_file: cppcheck_report.txt

      # -------------------------------
      # 3. Install GCC (MinGW)
      # -------------------------------
      - name: Install GCC (MinGW)
        run: |
          choco install -y mingw make
          refreshenv
          gcc --version

      # -------------------------------
      # 4. Build C code
      # -------------------------------
      - name: Build C application
        run: |
          echo "Compiling source files..."
          gcc src/Main.c -o main.exe
          echo "Build completed successfully."

      # -------------------------------
      # 5. Upload build + report artifacts
      # -------------------------------
      - name: Upload build and analysis artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-and-analysis-results
          path: |
            main.exe
            cppcheck_report.txt