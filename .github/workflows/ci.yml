name: C CI/CD with Static Analysis and Build

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch: {}

jobs:
  # -------------------------------
  # 1. Static Analysis Job (Linux)
  # -------------------------------
  cppcheck:
    name: Static Analysis (Cppcheck)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Run Cppcheck
        uses: deep5050/cppcheck-action@main
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          enable: all
          std: c11
          output_file: cppcheck_report.txt
          fail_on_error: true

      - name: Upload Cppcheck report
        uses: actions/upload-artifact@v4
        with:
          name: cppcheck-report
          path: cppcheck_report.txt

  # -------------------------------
  # 2. Build Job (Windows)
  # -------------------------------
  build:
    name: Build (GCC on Windows)
    runs-on: windows-latest
    needs: cppcheck
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install GCC (MinGW)
        run: |
          choco install -y mingw make
          refreshenv
          gcc --version

      - name: Build application
        run: |
          echo "Compiling source files..."
          gcc src/Main.c -o main.exe
          echo "Build completed successfully."

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: build-results
          path: main.exe
